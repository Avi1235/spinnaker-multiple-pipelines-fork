buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id("io.spinnaker.plugin.bundler").version("$spinnakerGradleVersion")
    id "com.palantir.docker" version "0.33.0"
}

version 'v1.0.1'

spinnakerBundle {
    pluginId = "Armory.RunMultiplePipelines"
    description = "This plugin adds a new custom stage to Spinnaker to trigger multiple child pipelines."
    provider = "https://armory.io"
    version = rootProject.version
}

subprojects { project ->
    group = "io.armory.plugin.smp"
    version = rootProject.version
    apply plugin: "maven-publish"
}

task version() {
    println(version)
}

docker {
    dockerfile project.file("build-tools/Dockerfile")
    def registry = System.getenv('REGISTRY') ?: "docker.io"
    def registryOrg = System.getenv('REGISTRY_ORG') ?: "armory"
    name "$registry/$registryOrg/multiplepipelines-plugin:$version"
    files project.file("build/distributions"), project.file("build-tools/install.sh")
    buildArgs([PLUGIN_ID: "RunMultiplePipelines-$version"])
    copySpec.from("build/distributions").into("distributions")
}
